name: Security Scanning

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1' # Weekly security scan on Mondays at 2 AM

permissions:
  contents: read
  security-events: write
  actions: read
  issues: write

jobs:
  # Go vulnerability scanning
  govulncheck:
    name: Go Vulnerability Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23.5'

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        run: govulncheck -json ./... > govulncheck-results.json

      - name: Process vulnerability results
        run: |
          if [ -s govulncheck-results.json ]; then
            echo "Vulnerabilities found:"
            cat govulncheck-results.json

            # Check for high severity vulnerabilities
            HIGH_VULNS=$(jq '.vulns[] | select(.severity == "HIGH")' govulncheck-results.json | wc -l)
            if [ "$HIGH_VULNS" -gt 0 ]; then
              echo "High severity vulnerabilities found: $HIGH_VULNS"
              exit 1
            fi
          else
            echo "No vulnerabilities found"
          fi

      - name: Upload vulnerability report
        uses: actions/upload-artifact@v4
        with:
          name: govulncheck-report
          path: govulncheck-results.json

  # Dependency scanning
  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23.5'

      - name: Download dependencies
        run: go mod download

      - name: Run Nancy (dependency scanner)
        run: |
          go install github.com/sonatypecommunity/nancy@latest
          go list -json -deps ./... | nancy sleuth --exclude-vulnerability-file ./.nancy-ignore

      - name: Generate dependency report
        run: |
          echo "# Dependency Security Report" > dependency-report.md
          echo "Generated on: $(date)" >> dependency-report.md
          echo "" >> dependency-report.md
          echo "## Dependencies" >> dependency-report.md
          go list -m all >> dependency-report.md

      - name: Upload dependency report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: dependency-report.md

  # Secret scanning
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Run TruffleHog
        if: github.event_name == 'pull_request'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: HEAD
          extra_args: --debug --only-verified

  # SAST (Static Application Security Testing)
  sast:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23.5'

      - name: Run gosec
        run: |
          go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
          gosec -fmt sarif -out gosec-results.sarif ./...

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gosec-results.sarif
        continue-on-error: true

      - name: Run semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/golang

  # Container security scanning
  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [ingest, retrieve, websearch, synthesize, teamsbot]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: cmd/${{ matrix.service }}/Dockerfile
          load: true
          tags: ai-sa-assistant-${{ matrix.service }}:scan

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ai-sa-assistant-${{ matrix.service }}:scan
          format: 'sarif'
          output: 'trivy-results-${{ matrix.service }}.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results-${{ matrix.service }}.sarif'
        continue-on-error: true

      - name: Run Grype vulnerability scanner
        uses: anchore/scan-action@v3
        with:
          image: ai-sa-assistant-${{ matrix.service }}:scan
          fail-build: true
          severity-cutoff: high

      - name: Upload Grype scan results
        uses: actions/upload-artifact@v4
        with:
          name: grype-results-${{ matrix.service }}
          path: anchore-reports/

  # License compliance
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23.5'

      - name: Install go-licenses
        run: go install github.com/google/go-licenses@latest

      - name: Check licenses
        run: |
          go-licenses report ./... > licenses-report.txt

          # Check for prohibited licenses
          PROHIBITED_LICENSES="GPL-3.0 AGPL-3.0 LGPL-3.0"
          for license in $PROHIBITED_LICENSES; do
            if grep -q "$license" licenses-report.txt; then
              echo "Prohibited license found: $license"
              exit 1
            fi
          done

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: licenses-report
          path: licenses-report.txt

  # Supply chain security
  supply-chain:
    name: Supply Chain Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23.5'

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.spdx.json

      - name: Run SLSA verification
        run: |
          echo "SLSA verification skipped in demo environment"
          echo "In production, use: slsa-verifier verify-image --source-uri github.com/owner/repo"

  # Security policy compliance
  policy-check:
    name: Security Policy Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for security policy
        run: |
          if [ ! -f SECURITY.md ]; then
            echo "SECURITY.md file is missing"
            exit 1
          fi

      - name: Validate Dockerfile security
        run: |
          # Check for non-root user
          for dockerfile in cmd/*/Dockerfile; do
            if ! grep -q "USER " "$dockerfile"; then
              echo "Dockerfile $dockerfile does not specify a non-root user"
              exit 1
            fi
          done

      - name: Check for secrets in code
        run: |
          # Check for common secret patterns
          if grep -r -i -E "(password|secret|key|token).*=.*['\"][^'\"]{8,}['\"]" . --exclude-dir=.git; then
            echo "Potential hardcoded secrets found"
            exit 1
          fi

  # Security notification
  security-alert:
    name: Security Alert
    runs-on: ubuntu-latest
    needs: [govulncheck, dependency-check, secret-scan, sast, container-scan, license-check, supply-chain, policy-check]
    if: failure()
    steps:
      - name: Send security alert
        uses: actions/github-script@v6
        with:
          script: |
            const payload = {
              text: `ðŸš¨ Security Scan Failed for ${context.repo.repo}`,
              attachments: [{
                color: 'danger',
                title: 'Security Vulnerabilities Detected',
                fields: [{
                  title: 'Repository',
                  value: context.repo.repo,
                  short: true
                }, {
                  title: 'Branch',
                  value: context.ref,
                  short: true
                }, {
                  title: 'Commit',
                  value: context.sha.substring(0, 7),
                  short: true
                }, {
                  title: 'Workflow',
                  value: context.workflow,
                  short: true
                }],
                footer: 'Immediate attention required'
              }]
            };

            // Create GitHub issue for security findings
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Security Scan Failed - ${context.sha.substring(0, 7)}`,
              body: `Security vulnerabilities detected in commit ${context.sha}.\n\nPlease review the security scan results and address any findings.`,
              labels: ['security', 'urgent']
            });

  # Generate security report
  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    needs: [govulncheck, dependency-check, secret-scan, sast, container-scan, license-check, supply-chain, policy-check]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate security report
        run: |
          echo "# Security Scan Report" > security-report.md
          echo "Generated on: $(date)" >> security-report.md
          echo "Commit: ${{ github.sha }}" >> security-report.md
          echo "" >> security-report.md

          echo "## Scan Results" >> security-report.md
          echo "- Go Vulnerability Check: ${{ needs.govulncheck.result }}" >> security-report.md
          echo "- Dependency Check: ${{ needs.dependency-check.result }}" >> security-report.md
          echo "- Secret Scan: ${{ needs.secret-scan.result }}" >> security-report.md
          echo "- Static Analysis: ${{ needs.sast.result }}" >> security-report.md
          echo "- Container Scan: ${{ needs.container-scan.result }}" >> security-report.md
          echo "- License Check: ${{ needs.license-check.result }}" >> security-report.md
          echo "- Supply Chain: ${{ needs.supply-chain.result }}" >> security-report.md
          echo "- Policy Check: ${{ needs.policy-check.result }}" >> security-report.md

          echo "" >> security-report.md
          echo "## Recommendations" >> security-report.md
          echo "- Keep dependencies updated" >> security-report.md
          echo "- Review and rotate secrets regularly" >> security-report.md
          echo "- Monitor for new vulnerabilities" >> security-report.md
          echo "- Implement security controls in Docker containers" >> security-report.md

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md
