services:
  chromadb:
    image: chromadb/chroma:0.5.0
    ports:
      - "8000:8000"
    volumes:
      - chromadb_data:/chroma/.chroma/
    # Note: Health check removed due to minimal container lacking network tools
    # API accessibility is validated externally via http://localhost:8000/api/v2/heartbeat

  retrieve:
    build:
      context: .
      dockerfile: cmd/retrieve/Dockerfile
    ports:
      - "8081:8081"
    volumes:
      - ./configs:/app/configs
      - metadata_data:/app/data
    depends_on:
      - chromadb
    env_file:
      - .env
    environment:
      - CONFIG_PATH=/app/configs/config.yaml

  websearch:
    build:
      context: .
      dockerfile: cmd/websearch/Dockerfile
    ports:
      - "8083:8083"
    volumes:
      - ./configs:/app/configs
      - metadata_data:/app/data
    env_file:
      - .env
    environment:
      - CONFIG_PATH=/app/configs/config.yaml

  synthesize:
    build:
      context: .
      dockerfile: cmd/synthesize/Dockerfile
    ports:
      - "8082:8082"
    volumes:
      - ./configs:/app/configs
      - metadata_data:/app/data
    env_file:
      - .env
    environment:
      - CONFIG_PATH=/app/configs/config.yaml

  teamsbot:
    build:
      context: .
      dockerfile: cmd/teamsbot/Dockerfile
    ports:
      - "8080:8080"
    volumes:
      - ./configs:/app/configs
      - ./feedback.log:/app/feedback.log
      - metadata_data:/app/data
    depends_on:
      - retrieve
      - websearch
      - synthesize
    env_file:
      - .env
    environment:
      - CONFIG_PATH=/app/configs/config.yaml

  webui:
    build:
      context: .
      dockerfile: cmd/webui/Dockerfile
    ports:
      - "8084:8080"
    volumes:
      - ./configs:/app/configs
      - metadata_data:/app/data
    depends_on:
      - retrieve
      - websearch
      - synthesize
    env_file:
      - .env
    environment:
      - CONFIG_PATH=/app/configs/config.yaml

  ingest:
    build:
      context: .
      dockerfile: cmd/ingest/Dockerfile
    volumes:
      - ./configs:/app/configs
      - ./docs:/app/docs
      - metadata_data:/app/data
    depends_on:
      - chromadb
    env_file:
      - .env
    environment:
      - CONFIG_PATH=/app/configs/config.yaml
    profiles:
      - ingest
    command: ["./ingest", "-d", "/app/docs", "-c", "/app/configs/config.yaml"]

volumes:
  chromadb_data:
  metadata_data:
